name: Quality Gates

on:
  push:
  pull_request:

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    env:
      GODOT_VERSION: "4.6-stable"
      GODOT_BIN: "${{ github.workspace }}/godot/Godot_v4.6-stable_linux.x86_64"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Godot
        run: |
          mkdir -p godot
          curl -L -o godot/godot.zip "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}/Godot_v4.6-stable_linux.x86_64.zip"
          unzip -o godot/godot.zip -d godot
          chmod +x "${GODOT_BIN}"

      - name: Run Headless Tests
        run: ./scripts/run_tests_strict.sh "${GODOT_BIN}"

      - name: Run Terrain Perf Gate
        run: "${GODOT_BIN}" --headless -s res://scripts/terrain_perf_gate.gd ./tests/fixtures/terrain_perf_metrics_pass.json

      - name: Run Visual Parity Matrix Gate
        run: "${GODOT_BIN}" --headless -s res://scripts/run_visual_parity_matrix_ci.gd
